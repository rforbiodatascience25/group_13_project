---
title: "03_prediction"
format: html
---

Loading libraries

```{r}
library("tidyverse")
library("here")
library("tidymodels")


```

loading data

```{r}
clean_path <- here("data/02_data_clean.csv")

clean_df <- read_csv(clean_path, show_col_types = FALSE)

```

defining two classes. Based on Knlowedge provided by Ãkos, we will spit the receptors into 3 classes: Glutamate, Cys-loop and Other receptors (which includes 2 ionotropic receptors not part of the other 2 superfamilies). It would be interesting to see if we can predict the class from AA composition. To do this we first add a new column to the meta_df called "class".

```{r}
clean_classed_df <- clean_df |> 
    mutate(
      Receptor_class = case_when(
          str_detect(Protein_Name, "Glutamate") ~ "Glutamate",
          str_detect(Protein_Name, "Ionotropic")  ~ "Ionotropic",
          TRUE       ~ "CysLoop"
  )
)

clean_classed_df
```

```{r}
prediction_df <- clean_classed_df |>
  select(Protein_ID, Receptor_class, starts_with("aa_"))
prediction_df
```

split it into training and test:

```{r}

set.seed(123)
split  <- initial_split(prediction_df, prop = 0.8, strata = Receptor_class)
train  <- training(split)
test   <- testing(split)
```

define a recipe

```{r}
rec <- recipe(Receptor_class ~ ., data = train) |>
  step_select(Receptor_class, starts_with("aa_"))
```

a workflow

```{r}
rf_simple <- rand_forest(trees = 1000) |>
  set_engine("randomForest") |>
  set_mode("classification")

wf_simple <- workflow() |>
  add_recipe(rec) |>
  add_model(rf_simple)

```

fit model

```{r}
fit_simple <- wf_simple |> last_fit(split)
metrics <- collect_metrics(fit_simple)
metrics
```

plot metrics

```{r}
ggplot(metrics, aes(x = .metric, y = .estimate)) +
  geom_col() +
  labs(x = "Metric", y = "Estimate")
```

```{r}
fit <- fit_simple$.workflow[[1]] |> extract_fit_parsnip()
rf_obj <- fit$fit          # randomForest object

plot(rf_obj)

```
