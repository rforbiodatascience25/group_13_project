---
title: "03_prediction"
format: html
---


Loading libraries

```{r}
library("tidyverse")
library("here")
library("tidymodels")


```


loading data 
```{r}
meta_path <- here("data/01_dat_meta_load.csv")
feat_path <- here("data/01_dat_feature_load.csv")

meta_df <- read_csv(meta_path, show_col_types = FALSE)
feature_df <- read_csv(feat_path, show_col_types = FALSE)

```
baldas 

```{r}
meta_df
```


```{r}
feature_df
```
defining two classes. Based on Knlowedge provided by Ãkos, we will spit the receptors into 3 classes: Glutamate, Ionotropic and Cysloop receptors. It would be interesting to see if we can predict the class from AA composition.
Todo this we first add a new column to the meta df called "class".

```{r}
meta_classed_df <- meta_df |> 
    mutate(
      Receptor_class = case_when(
          str_detect(Protein_Name, "Glutamate") ~ "Glutamate",
          str_detect(Protein_Name, "Ionotropic")  ~ "Ionotropic",
          TRUE       ~ "CysLoop"
  )
)

meta_classed_df
```

```{r}
joined_classed_df <- meta_classed_df |>
         select(Protein_ID, Receptor_class) |>
         bind_cols(feature_df |>
                      select(starts_with("aa_")))
joined_classed_df
```
split it into training and test:

```{r}

set.seed(123)
split  <- initial_split(joined_classed_df, prop = 0.8, strata = Receptor_class)
train  <- training(split)
test   <- testing(split)
```

define a recipe

```{r}
rec <- recipe(Receptor_class ~ ., data = train) |>
  step_select(Receptor_class, starts_with("aa_"))
```

a workflow

```{r}
rf_simple <- rand_forest(trees = 1000) |>
  set_engine("randomForest") |>
  set_mode("classification")

wf_simple <- workflow() |>
  add_recipe(rec) |>
  add_model(rf_simple)

```

fit model

```{r}
fit_simple <- wf_simple |> last_fit(split)
metrics <- collect_metrics(fit_simple)
metrics
```
plot metrics 

```{r}
ggplot(metrics, aes(x = .metric, y = .estimate)) +
  geom_col() +
  labs(x = "Metric", y = "Estimate")
```
```{r}
fit <- fit_simple$.workflow[[1]] |> extract_fit_parsnip()
rf_obj <- fit$fit          # randomForest object

plot(rf_obj)

```

